Timer unit: 3.0186e-07 s

Total time: 238.193 s
File: _01_compare_pairwise_stations.py
Function: find_simulataneous_events at line 61

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
    61                                           @profile
    62                                           def find_simulataneous_events(ppt_thrs_lst, stns_ids_lst,
    63                                                                         time_shifts_lst, time_shifts_arr,
    64                                                                         out_dir):
    65                                           
    66         1         11.0     11.0      0.0      for thr in ppt_thrs_lst:
    67         1        535.0    535.0      0.0          print('PPT Threshold is: ', thr, ' mm')
    68        29        772.0     26.6      0.0          for ii, iid in enumerate(stns_ids_lst):
    69        29     114356.0   3943.3      0.0              print('First Station ID is: ', iid, ' Station Index is ', ii)
    70        29        317.0     10.9      0.0              try:
    71                                                           # read station one
    72        29    5959099.0 205486.2      0.8                  idf1 = HDF52.get_pandas_dataframe(ids=[iid])
    73                                                       except Exception as msg:
    74                                                           print(msg)
    75                                                           continue
    76                                                       # select values above threshold and drop nans
    77        29     965751.0  33301.8      0.1              stn1_abv_thr = idf1[idf1 >= thr]
    78        29    1626847.0  56098.2      0.2              stn1_abv_thr.dropna(inplace=True)
    79                                           
    80        29       4973.0    171.5      0.0              if len(stn1_abv_thr.values) > 0:
    81                                           
    82                                                           # start going through events of station one
    83         2        284.0    142.0      0.0                  for ix, val in zip(stn1_abv_thr.index, stn1_abv_thr.values):
    84         1       1530.0   1530.0      0.0                      print('First time index is:', ix, 'Ppt Station 1 is ', val)
    85                                           
    86                                                               # remove the id of the first station from all IDS
    87         1       4295.0   4295.0      0.0                      ids2 = np.array(list(filter(lambda x: x != iid, ids)))
    88                                           
    89                                                               # create new dataframe to hold the ouput per event
    90         1         12.0     12.0      0.0                      df_result = pd.DataFrame(columns=ids2,
    91         1     633657.0 633657.0      0.1                                               index=time_shifts_arr)
    92                                           
    93                                                               # to know where the iteration is
    94         1         13.0     13.0      0.0                      count_all_stns = len(ids2)
    95                                           
    96       950      23897.0     25.2      0.0                      for ii2, iid2 in enumerate(ids2):
    97                                           
    98       949       6691.0      7.1      0.0                          if ii2 != 73:
    99       948       6977.0      7.4      0.0                              print('Second Station ID is: ', iid2,
   100       948       5075.0      5.4      0.0                                    ' index is ', ii2,
   101       948     362564.0    382.5      0.0                                    ' Count of Stns is :', count_all_stns)
   102                                                                   # read second station
   103       948  517456998.0 545840.7     65.6                              idf2 = HDF52.get_pandas_dataframe(ids=[iid2])
   104                                           #                         try:
   105                                           #                             idf2 = HDF52.get_pandas_dataframe(ids=[iid2])
   106                                           #                         except Exception as msg:
   107                                           #                             print(msg)
   108                                           #                             continue
   109                                           
   110                                                                   # select values above threshold and drop nans
   111       948   66367946.0  70008.4      8.4                              stn2_abv_thr = idf2[idf2 >= thr]
   112                                           #                             stn2_abv_thr.dropna(inplace=True)
   113                                           
   114       948     231056.0    243.7      0.0                              if len(stn2_abv_thr.values) > 0:
   115                                                                           # check if at the time event at stn2
   116                                           
   117       948   33554927.0  35395.5      4.3                                  if ix in stn2_abv_thr.index:
   118       932     490883.0    526.7      0.1                                      print('Same time in Station 2', ix)
   119                                           
   120       932    2528328.0   2712.8      0.3                                      val2 = stn2_abv_thr.loc[ix, :].values[0]
   121                                           
   122       932     280769.0    301.3      0.0                                      print(' Ppt at Station 2 is', val2)
   123       932    7746528.0   8311.7      1.0                                      df_result.loc[0, iid2] = val2
   124                                           
   125     12324      98411.0      8.0      0.0                                  for time_shift in time_shifts_lst:
   126     11376    4531140.0    398.3      0.6                                      print('Shifting time by +- ', time_shift)
   127                                           
   128                                                                               # get the shift as float, for index in df
   129                                                                               shift_minutes = (
   130     11376     280278.0     24.6      0.0                                          time_shift / 60).total_seconds()
   131                                           
   132     11376     843212.0     74.1      0.1                                      ix2_pos = ix + time_shift  # pos shifted
   133     11376     462154.0     40.6      0.1                                      ix2_neg = ix - time_shift  # neg shifted
   134                                           
   135     11376    1572830.0    138.3      0.2                                      if ix2_pos in stn2_abv_thr.index:
   136     11184    3274545.0    292.8      0.4                                          print('+ shifted idx present', ix2_pos)
   137                                           
   138     11184     135001.0     12.1      0.0                                          val2_pos = stn2_abv_thr.loc[
   139     11184   20797373.0   1859.6      2.6                                              ix2_pos, :].values[0]
   140                                           
   141                                                                                   df_result.loc[shift_minutes,
   142     11184   19118462.0   1709.4      2.4                                                        iid2] = val2_pos
   143                                           
   144     11376    1558103.0    137.0      0.2                                      if ix2_neg in stn2_abv_thr.index:
   145     11184    4672353.0    417.8      0.6                                          print('- shifted idx present', ix2_neg)
   146                                           
   147     11184     106907.0      9.6      0.0                                          shift_minutes_neg = - shift_minutes
   148                                           
   149     11184     113828.0     10.2      0.0                                          val2_neg = stn2_abv_thr.loc[
   150     11184   20588300.0   1840.9      2.6                                              ix2_neg, :].values[0]
   151                                                                                   df_result.loc[shift_minutes_neg,
   152     11184   18892008.0   1689.2      2.4                                                        iid2] = val2_neg
   153                                           
   154       948    7019147.0   7404.2      0.9                              del (idf2, stn2_abv_thr)
   155       948      16049.0     16.9      0.0                              count_all_stns -= 1
   156       949   11799778.0  12433.9      1.5                          df_result.dropna(axis=1, how='all', inplace=True)
   157                                                                   # save df for every event
   158       949       9466.0     10.0      0.0                          df_result.to_csv(
   159       949       9590.0     10.1      0.0                              os.path.join(
   160       949       5391.0      5.7      0.0                                  out_dir,
   161       949       4743.0      5.0      0.0                                  'ppt_val_%0.2f_date_%s_stn_%s_thr_%s.csv'
   162       949       5171.0      5.4      0.0                                  % (val,
   163       949      49689.0     52.4      0.0                                     ix.isoformat().replace(':', '_').replace('T', '_'),
   164       949     117031.0    123.3      0.0                                     iid, thr)),
   165       949   34612154.0  36472.2      4.4                              float_format='%0.2f')
   166                                                               else:
   167         1        248.0    248.0      0.0                          print('Station has no data ', ii2)
   168         1          6.0      6.0      0.0                          continue
   169                                                       else:
   170        28      13545.0    483.8      0.0                  print('Station %s, has no data above % 0.1f mm' % (iid, thr))
   171        28        279.0     10.0      0.0                  continue
   172         1          8.0      8.0      0.0              break
   173         1          4.0      4.0      0.0          break

